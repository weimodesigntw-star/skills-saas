# ğŸ—ï¸ åŸºç¤æ¶æ§‹æª¢è¦–å ±å‘Š

## ğŸ“Š ç•¶å‰ç‹€æ…‹åˆ†æ

### âœ… æ­£å¸¸é‹ä½œçš„éƒ¨åˆ†

1. **Supabase é€£æ¥**
   - ç’°å¢ƒè®Šæ•¸å·²æ­£ç¢ºè¨­ç½®
   - Supabase Auth Logs é¡¯ç¤ºç™»å…¥æˆåŠŸ
   - `/auth/v1/token` è«‹æ±‚è¿”å› 200

2. **Cookies è¨­ç½®**
   - Application æ¨™ç±¤ä¸­ cookies å­˜åœ¨
   - Cookie åç¨±æ­£ç¢ºï¼š`sb-ucwcavjnqalnxnisiuha-auth-token`
   - Cookie å€¼åŒ…å« `access_token`

3. **Cookies å‚³è¼¸**
   - Middleware èƒ½è®€å–åˆ° cookies
   - çµ‚ç«¯æ©Ÿæ—¥èªŒé¡¯ç¤ºï¼š`åŸå§‹ cookies æ•¸é‡: 4`
   - åŒ…å« Supabase cookie

### âŒ å•é¡Œéƒ¨åˆ†

1. **Session è§£æå¤±æ•—**
   - `getSession()` è¿”å› `hasSession: false`
   - `getClaims()` è¿”å› `{ data: null, error: null }`
   - `getUser()` è¿”å› `'Auth session missing!'`

2. **Cookie å€¼æ ¼å¼**
   - Cookie å€¼æ˜¯ URL ç·¨ç¢¼çš„ JSON
   - æ ¼å¼ï¼š`%7B%22access_token%22%3A%22eyJ...`
   - é€™å¯èƒ½æ˜¯ Supabase SSR çš„é æœŸæ ¼å¼

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### å‡è¨­ 1ï¼šCookie å€¼æ ¼å¼å•é¡Œ

**ç¾è±¡ï¼š**
- Cookie å€¼æ˜¯ URL ç·¨ç¢¼çš„ JSON å­—ä¸²
- Supabase SSR å¯èƒ½ç„¡æ³•æ­£ç¢ºè§£æ

**é©—è­‰æ–¹æ³•ï¼š**
- æª¢æŸ¥ Supabase SSR æ˜¯å¦è‡ªå‹•è™•ç† URL è§£ç¢¼
- æª¢æŸ¥ cookie å€¼çš„å¯¦éš›å…§å®¹

### å‡è¨­ 2ï¼šSupabase SSR ç‰ˆæœ¬å•é¡Œ

**ç¾è±¡ï¼š**
- ä½¿ç”¨ `@supabase/ssr@0.1.0`
- å·²çŸ¥ 0.0.8 ç‰ˆæœ¬æœ‰ bug
- å¯èƒ½ 0.1.0 ä¹Ÿæœ‰é¡ä¼¼å•é¡Œ

**é©—è­‰æ–¹æ³•ï¼š**
- æª¢æŸ¥æ˜¯å¦æœ‰æ›´æ–°çš„ç‰ˆæœ¬
- æŸ¥çœ‹ GitHub Issues

### å‡è¨­ 3ï¼šMiddleware é…ç½®å•é¡Œ

**ç¾è±¡ï¼š**
- `getClaims()` è¿”å› `null` ä½†æ²’æœ‰éŒ¯èª¤
- é€™è¡¨ç¤º Supabase å®¢æˆ¶ç«¯ç„¡æ³•å¾ cookie ä¸­æå– session

**é©—è­‰æ–¹æ³•ï¼š**
- æª¢æŸ¥ Middleware çš„ cookies è™•ç†é‚è¼¯
- ç¢ºèª Supabase å®¢æˆ¶ç«¯é…ç½®æ­£ç¢º

---

## ğŸ› ï¸ å»ºè­°çš„è§£æ±ºæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šæª¢æŸ¥ä¸¦ä¿®æ­£ Cookie è§£æ

Supabase SSR æ‡‰è©²è‡ªå‹•è™•ç† URL ç·¨ç¢¼ï¼Œä½†å¦‚æœæ²’æœ‰ï¼Œå¯èƒ½éœ€è¦æ‰‹å‹•è§£ç¢¼ã€‚

### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨ä¸åŒçš„èªè­‰æ–¹æ³•

å¦‚æœ `getSession()` å’Œ `getClaims()` éƒ½å¤±æ•—ï¼Œå¯èƒ½éœ€è¦ï¼š
- ç›´æ¥å¾ cookie ä¸­è§£æ token
- æ‰‹å‹•é©—è­‰ token
- æˆ–è€…ä½¿ç”¨ä¸åŒçš„ Supabase å®¢æˆ¶ç«¯é…ç½®

### æ–¹æ¡ˆ 3ï¼šæª¢æŸ¥ Supabase å°ˆæ¡ˆé…ç½®

ç¢ºèªï¼š
- Supabase å°ˆæ¡ˆçš„ Auth è¨­ç½®æ­£ç¢º
- JWT è¨­ç½®æ­£ç¢º
- æ²’æœ‰é¡å¤–çš„å®‰å…¨é™åˆ¶

---

## ğŸ“‹ ä¸‹ä¸€æ­¥è¡Œå‹•

1. **æª¢æŸ¥ Cookie å€¼çš„å¯¦éš›å…§å®¹**
   - è§£ç¢¼ URL ç·¨ç¢¼çš„ cookie å€¼
   - ç¢ºèª JSON æ ¼å¼æ­£ç¢º

2. **æª¢æŸ¥ Supabase SSR ç‰ˆæœ¬**
   - ç¢ºèªæ˜¯å¦æœ‰æ›´æ–°ç‰ˆæœ¬
   - æŸ¥çœ‹å·²çŸ¥å•é¡Œ

3. **å˜—è©¦ä¸åŒçš„èªè­‰æ–¹æ³•**
   - ä½¿ç”¨ `getSession()` è€Œä¸æ˜¯ `getUser()`
   - æˆ–è€…æ‰‹å‹•è§£æ cookie

4. **æª¢æŸ¥ Supabase å°ˆæ¡ˆè¨­ç½®**
   - ç¢ºèª Auth é…ç½®æ­£ç¢º
   - æª¢æŸ¥ JWT è¨­ç½®

---

## ğŸ”§ æŠ€è¡“ç´°ç¯€

### Cookie æ ¼å¼

Supabase SSR ä½¿ç”¨ä»¥ä¸‹æ ¼å¼å­˜å„² sessionï¼š
```
sb-<project-ref>-auth-token = URL_ENCODED_JSON
```

JSON å…§å®¹ï¼š
```json
{
  "access_token": "eyJ...",
  "refresh_token": "eyJ...",
  "expires_at": 1234567890,
  "expires_in": 3600,
  "token_type": "bearer",
  "user": { ... }
}
```

### Middleware è™•ç†æµç¨‹

1. è®€å– `request.cookies`
2. å‚³éçµ¦ Supabase SSR çš„ `getAll()`
3. Supabase SSR è§£æ cookies
4. èª¿ç”¨ `getSession()` æˆ– `getUser()`
5. è¿”å› user æˆ– null

### å¯èƒ½çš„å•é¡Œé»

1. **Cookie è§£æ**ï¼šSupabase SSR å¯èƒ½ç„¡æ³•æ­£ç¢ºè§£æ URL ç·¨ç¢¼çš„å€¼
2. **Token é©—è­‰**ï¼šå³ä½¿è§£ææˆåŠŸï¼Œtoken å¯èƒ½ç„¡æ³•é€šéé©—è­‰
3. **é…ç½®ä¸åŒ¹é…**ï¼šå®¢æˆ¶ç«¯å’Œæœå‹™ç«¯çš„é…ç½®å¯èƒ½ä¸ä¸€è‡´

---

## ğŸ¯ å„ªå…ˆç´š

1. **é«˜å„ªå…ˆç´š**ï¼šæª¢æŸ¥ Cookie å€¼çš„å¯¦éš›å…§å®¹å’Œè§£ç¢¼
2. **ä¸­å„ªå…ˆç´š**ï¼šæª¢æŸ¥ Supabase SSR ç‰ˆæœ¬å’Œå·²çŸ¥å•é¡Œ
3. **ä½å„ªå…ˆç´š**ï¼šæª¢æŸ¥ Supabase å°ˆæ¡ˆé…ç½®
